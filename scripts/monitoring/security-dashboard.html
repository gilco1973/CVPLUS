<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVPlus Security Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #10b981;
        }

        .status-indicator.warning {
            background: #f59e0b;
        }

        .status-indicator.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .metric-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 14px;
            color: #666;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
        }

        #authChart, #performanceChart {
            height: 300px;
        }

        .alerts-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .alerts-container h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .alert-item {
            padding: 15px;
            border-left: 4px solid;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 5px;
        }

        .alert-item.critical {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .alert-item.warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .alert-item.info {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .alert-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .alert-message {
            font-size: 14px;
            color: #333;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”’ CVPlus Security Monitoring Dashboard</h1>
            <div class="status">
                <div class="status-indicator online"></div>
                <span id="status-text">System Online</span>
                <span style="margin-left: auto; color: #666;">Last Updated: <span id="last-updated">--</span></span>
                <button class="refresh-btn" onclick="refreshData()">Refresh</button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Total Requests (24h)</h3>
                <div class="metric-value" id="total-requests">0</div>
                <div class="metric-change positive">+12% from yesterday</div>
            </div>

            <div class="metric-card">
                <h3>Auth Failures</h3>
                <div class="metric-value" id="auth-failures">0</div>
                <div class="metric-change negative">+3 in last hour</div>
            </div>

            <div class="metric-card">
                <h3>Active Users</h3>
                <div class="metric-value" id="active-users">0</div>
                <div class="metric-change positive">+5% from last week</div>
            </div>

            <div class="metric-card">
                <h3>CSP Violations</h3>
                <div class="metric-value" id="csp-violations">0</div>
                <div class="metric-change">No change</div>
            </div>

            <div class="metric-card">
                <h3>API Response Time</h3>
                <div class="metric-value" id="response-time">0ms</div>
                <div class="metric-change positive">-15ms improvement</div>
            </div>

            <div class="metric-card">
                <h3>Security Score</h3>
                <div class="metric-value" id="security-score">95%</div>
                <div class="metric-change positive">All checks passing</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>Authentication Activity (Last 24 Hours)</h2>
            <canvas id="authChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Performance Metrics</h2>
            <canvas id="performanceChart"></canvas>
        </div>

        <div class="alerts-container">
            <h2>Recent Security Alerts</h2>
            <div id="alerts-list">
                <div class="alert-item info">
                    <div class="alert-time">10 minutes ago</div>
                    <div class="alert-message">Security headers successfully deployed</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            orderBy, 
            limit, 
            onSnapshot,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAnalytics, 
            logEvent 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiu-p9h5XmX4QLykXpzVMEJNM0clKcdXk",
            authDomain: "cvplus-app.firebaseapp.com",
            projectId: "cvplus-app",
            storageBucket: "cvplus-app.appspot.com",
            messagingSenderId: "652944433631",
            appId: "1:652944433631:web:a59098e0f088a0c3a8c84f",
            measurementId: "G-GH1M17NTH6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Chart instances
        let authChart, performanceChart;

        // Initialize charts
        function initCharts() {
            // Authentication Activity Chart
            const authCtx = document.getElementById('authChart').getContext('2d');
            authChart = new Chart(authCtx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(24),
                    datasets: [{
                        label: 'Successful Logins',
                        data: generateRandomData(24, 50, 200),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Failed Attempts',
                        data: generateRandomData(24, 0, 20),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Performance Metrics Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: ['processCV', 'generateTimeline', 'getRecommendations', 'generatePodcast', 'generateVideo'],
                    datasets: [{
                        label: 'Average Response Time (ms)',
                        data: [245, 389, 567, 1234, 2456],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(16, 185, 129, 0.5)',
                            'rgba(245, 158, 11, 0.5)',
                            'rgba(139, 92, 246, 0.5)',
                            'rgba(236, 72, 153, 0.5)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ec4899'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Generate time labels for chart
        function generateTimeLabels(hours) {
            const labels = [];
            const now = new Date();
            for (let i = hours - 1; i >= 0; i--) {
                const time = new Date(now - i * 60 * 60 * 1000);
                labels.push(time.getHours() + ':00');
            }
            return labels;
        }

        // Generate random data for demo
        function generateRandomData(count, min, max) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return data;
        }

        // Update metrics from Firestore
        async function updateMetrics() {
            try {
                // Listen to security events collection
                const eventsQuery = query(
                    collection(db, 'security_events'),
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );

                onSnapshot(eventsQuery, (snapshot) => {
                    let totalRequests = 0;
                    let authFailures = 0;
                    let cspViolations = 0;
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        totalRequests++;
                        if (data.type === 'auth_failure') authFailures++;
                        if (data.type === 'csp_violation') cspViolations++;
                    });

                    // Update UI
                    document.getElementById('total-requests').textContent = totalRequests.toLocaleString();
                    document.getElementById('auth-failures').textContent = authFailures;
                    document.getElementById('csp-violations').textContent = cspViolations;
                });

                // Simulate other metrics (replace with real data)
                document.getElementById('active-users').textContent = Math.floor(Math.random() * 1000 + 500);
                document.getElementById('response-time').textContent = Math.floor(Math.random() * 100 + 200) + 'ms';
                
                // Update last updated time
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error updating metrics:', error);
                addAlert('error', 'Failed to fetch metrics from Firestore');
            }
        }

        // Add alert to the list
        function addAlert(type, message) {
            const alertsList = document.getElementById('alerts-list');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item ${type}`;
            
            const alertTime = document.createElement('div');
            alertTime.className = 'alert-time';
            alertTime.textContent = 'Just now';
            
            const alertMessage = document.createElement('div');
            alertMessage.className = 'alert-message';
            alertMessage.textContent = message;
            
            alertItem.appendChild(alertTime);
            alertItem.appendChild(alertMessage);
            
            alertsList.insertBefore(alertItem, alertsList.firstChild);
            
            // Limit to 10 alerts
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        }

        // Refresh data
        window.refreshData = function() {
            updateMetrics();
            
            // Update charts with new random data (replace with real data)
            authChart.data.datasets[0].data = generateRandomData(24, 50, 200);
            authChart.data.datasets[1].data = generateRandomData(24, 0, 20);
            authChart.update();
            
            performanceChart.data.datasets[0].data = [
                Math.floor(Math.random() * 100 + 200),
                Math.floor(Math.random() * 200 + 300),
                Math.floor(Math.random() * 300 + 400),
                Math.floor(Math.random() * 500 + 1000),
                Math.floor(Math.random() * 1000 + 2000)
            ];
            performanceChart.update();
            
            addAlert('info', 'Dashboard refreshed successfully');
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateMetrics();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                refreshData();
            }, 30000);
            
            // Log dashboard view
            logEvent(analytics, 'security_dashboard_view');
        });
    </script>
</body>
</html>