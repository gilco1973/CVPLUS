graph TB
    subgraph "CURRENT STATE: DUAL ARCHITECTURE ANTI-PATTERN"
        subgraph "CORRECT LOCATION: /packages/recommendations/"
            PkgMain["ğŸ“¦ @cvplus/recommendations<br/>âœ… 4 files, modular structure"]
            PkgServices["ğŸ”§ services/<br/>recommendations.service.ts<br/>cache.service.ts<br/>ai-integration.service.ts"]
            PkgFrontend["âš›ï¸ frontend/hooks/<br/>useRecommendations.ts"]
            PkgTypes["ğŸ“ types/<br/>index.ts"]
            PkgUtils["ğŸ› ï¸ utils/<br/>retry.ts"]
        end
        
        subgraph "VIOLATION: /functions/src/services/recommendations/"
            ViolationFiles["âŒ 13 SERVICE FILES (2,394 lines)<br/>ğŸ“„ ActionOrchestrator.ts (237L)<br/>ğŸ“„ ValidationEngine.ts (251L)<br/>ğŸ“„ TransformationApplier.ts (228L)<br/>ğŸ“„ CacheManager.ts (223L)<br/>ğŸ“„ CircuitBreakerCore.ts (221L)<br/>ğŸ“„ RecommendationGenerator.ts (212L)<br/>ğŸ“„ RecommendationOrchestrator.ts (204L)<br/>ğŸ“„ + 6 more files<br/><br/>ğŸš¨ 7/13 files exceed 200-line limit"]
        end
        
        subgraph "Firebase Functions (Coupled to Violations)"
            FB1["ğŸ”¥ getRecommendations.ts"]
            FB2["ğŸ”¥ applyImprovements.ts"]
            FB3["ğŸ”¥ previewImprovement.ts"]
            FB4["ğŸ”¥ customizePlaceholders.ts"]
        end
    end
    
    subgraph "TARGET STATE: CONSOLIDATED MODULAR ARCHITECTURE"
        subgraph "Enhanced Package Structure: /packages/recommendations/"
            subgraph "ğŸ—ï¸ ENGINES LAYER"
                EngineAnalysis["ğŸ“Š engines/analysis/<br/>cv-analyzer.ts<br/>content-processor.ts"]
                EngineGeneration["âš¡ engines/generation/<br/>recommendation-generator.ts<br/>transformation-applier.ts"]
                EngineOrchestration["ğŸ­ engines/orchestration/<br/>action-orchestrator.ts<br/>recommendation-orchestrator.ts<br/>improvement-orchestrator.ts"]
                EngineValidation["âœ… engines/validation/<br/>validation-engine.ts"]
            end
            
            subgraph "ğŸ›ï¸ INFRASTRUCTURE LAYER"
                InfraCaching["ğŸ’¾ infrastructure/caching/<br/>cache-manager.ts<br/>cache-key-manager.ts"]
                InfraResilience["ğŸ›¡ï¸ infrastructure/resilience/<br/>circuit-breaker.ts<br/>retry-manager.ts<br/>timeout-manager.ts"]
                InfraMonitoring["ğŸ“Š infrastructure/monitoring/<br/>metrics.ts<br/>health-check.ts"]
            end
            
            subgraph "ğŸ”Œ INTEGRATION LAYER"
                IntegrationFirebase["ğŸ”¥ integration/firebase/<br/>functions-adapter.ts<br/>firestore-integration.ts<br/>auth-integration.ts"]
                IntegrationAPI["ğŸŒ integration/api/<br/>rest-adapter.ts<br/>graphql-adapter.ts"]
            end
            
            subgraph "âš›ï¸ ENHANCED FRONTEND"
                FrontendComponents["ğŸ§© frontend/components/<br/>RecommendationsList.tsx<br/>RecommendationCard.tsx<br/>RecommendationProgress.tsx"]
                FrontendHooks["ğŸ£ frontend/hooks/<br/>useRecommendations.ts<br/>useRecommendationCache.ts<br/>useRecommendationStatus.ts"]
            end
        end
        
        subgraph "Firebase Functions (Decoupled)"
            FBDecoupled["ğŸ”¥ Firebase Functions<br/>using @cvplus/recommendations<br/>via FirebaseFunctionsAdapter"]
        end
    end
    
    subgraph "MIGRATION PHASES"
        Phase1["ğŸ” PHASE 1: ASSESSMENT<br/>â€¢ Dependency mapping<br/>â€¢ Breaking change analysis<br/>â€¢ Risk assessment<br/>Days 1-2"]
        
        Phase2["ğŸ—ï¸ PHASE 2: PREPARATION<br/>â€¢ Package enhancement<br/>â€¢ 200-line compliance<br/>â€¢ Integration layer<br/>Days 3-5"]
        
        Phase3["ğŸšš PHASE 3: MIGRATION<br/>â€¢ Shadow implementation<br/>â€¢ Parallel operation<br/>â€¢ Full migration<br/>Days 6-10"]
        
        Phase4["ğŸ§ª PHASE 4: TESTING<br/>â€¢ Comprehensive testing<br/>â€¢ Performance validation<br/>â€¢ Quality gates<br/>Days 11-13"]
        
        Phase5["ğŸš€ PHASE 5: DEPLOYMENT<br/>â€¢ Staged rollout<br/>â€¢ Monitoring setup<br/>â€¢ Final validation<br/>Days 14-15"]
    end
    
    subgraph "SUCCESS METRICS"
        Metrics["ğŸ“ˆ TARGET ACHIEVEMENTS<br/>âœ… Timeout reduction: 15% â†’ 2% (87%)<br/>âœ… Cache hit rate: 0% â†’ 60%+<br/>âœ… Response time: 3min â†’ 30s (83%)<br/>âœ… 200-line compliance: 100%<br/>âœ… Test coverage: 90%+<br/>âœ… Zero breaking changes"]
    end
    
    %% Current State Relationships
    PkgMain --> PkgServices
    PkgMain --> PkgFrontend
    PkgMain --> PkgTypes
    PkgMain --> PkgUtils
    
    ViolationFiles --> FB1
    ViolationFiles --> FB2
    ViolationFiles --> FB3
    ViolationFiles --> FB4
    
    %% Target State Relationships  
    EngineAnalysis --> InfraCaching
    EngineGeneration --> InfraResilience
    EngineOrchestration --> InfraMonitoring
    EngineValidation --> IntegrationFirebase
    
    IntegrationFirebase --> FBDecoupled
    IntegrationAPI --> FBDecoupled
    
    FrontendComponents --> FrontendHooks
    
    %% Migration Flow
    Phase1 --> Phase2
    Phase2 --> Phase3
    Phase3 --> Phase4
    Phase4 --> Phase5
    Phase5 --> Metrics
    
    %% Critical Path
    ViolationFiles -.->|CONSOLIDATE| EngineAnalysis
    ViolationFiles -.->|CONSOLIDATE| EngineGeneration  
    ViolationFiles -.->|CONSOLIDATE| EngineOrchestration
    ViolationFiles -.->|CONSOLIDATE| EngineValidation
    ViolationFiles -.->|CONSOLIDATE| InfraCaching
    ViolationFiles -.->|CONSOLIDATE| InfraResilience
    
    FB1 -.->|DECOUPLE| FBDecoupled
    FB2 -.->|DECOUPLE| FBDecoupled
    FB3 -.->|DECOUPLE| FBDecoupled
    FB4 -.->|DECOUPLE| FBDecoupled
    
    classDef violation fill:#ffcccc,stroke:#ff0000,stroke-width:2px
    classDef correct fill:#ccffcc,stroke:#00aa00,stroke-width:2px
    classDef target fill:#cceeff,stroke:#0066cc,stroke-width:2px
    classDef phase fill:#ffffcc,stroke:#ccaa00,stroke-width:2px
    classDef metrics fill:#e6ccff,stroke:#9900cc,stroke-width:2px
    
    class ViolationFiles,FB1,FB2,FB3,FB4 violation
    class PkgMain,PkgServices,PkgFrontend,PkgTypes,PkgUtils correct
    class EngineAnalysis,EngineGeneration,EngineOrchestration,EngineValidation,InfraCaching,InfraResilience,InfraMonitoring,IntegrationFirebase,IntegrationAPI,FrontendComponents,FrontendHooks,FBDecoupled target
    class Phase1,Phase2,Phase3,Phase4,Phase5 phase
    class Metrics metrics