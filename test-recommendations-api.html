<!DOCTYPE html>
<html>
<head>
    <title>Test Recommendations API</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>Test Recommendations API</h1>
    <div id="output"></div>
    
    <script>
        // Firebase config for emulator
        const firebaseConfig = {
            apiKey: "demo-key",
            projectId: "getmycv-ai",
            databaseURL: "http://localhost:8080",
            storageBucket: "getmycv-ai.appspot.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        // Connect to emulators
        firebase.functions().useEmulator('localhost', 5001);
        firebase.auth().useEmulator('http://localhost:9099');
        
        const output = document.getElementById('output');
        
        function log(message, data = null) {
            console.log(message, data);
            const div = document.createElement('div');
            div.innerHTML = `<strong>${message}</strong>`;
            if (data) {
                div.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            output.appendChild(div);
        }
        
        async function testRecommendationsAPI() {
            try {
                log('Starting API test...');
                
                // First, sign in anonymously
                const userCredential = await firebase.auth().signInAnonymously();
                log('Signed in anonymously', { uid: userCredential.user.uid });
                
                // Test with a fake job ID
                const testJobId = 'test-job-' + Date.now();
                log('Testing with job ID:', testJobId);
                
                // Call the function
                const getRecommendations = firebase.functions().httpsCallable('getRecommendations');
                
                log('Calling getRecommendations...');
                const result = await getRecommendations({
                    jobId: testJobId,
                    targetRole: 'Software Engineer',
                    industryKeywords: ['JavaScript', 'React'],
                    forceRegenerate: true
                });
                
                log('Success! Function returned:', result);
                
                // Analyze the structure
                log('Response structure analysis:', {
                    hasData: !!result.data,
                    hasSuccess: !!result.data?.success,
                    hasDataData: !!result.data?.data,
                    hasRecommendations: !!result.data?.data?.recommendations,
                    recommendationsLength: result.data?.data?.recommendations?.length || 0,
                    recommendationsIsArray: Array.isArray(result.data?.data?.recommendations)
                });
                
                if (result.data?.data?.recommendations) {
                    log(`Found ${result.data.data.recommendations.length} recommendations`);
                    result.data.data.recommendations.forEach((rec, index) => {
                        log(`Recommendation ${index + 1}:`, {
                            id: rec.id,
                            title: rec.title,
                            priority: rec.priority,
                            impact: rec.impact
                        });
                    });
                }
                
            } catch (error) {
                log('Error occurred:', {
                    message: error.message,
                    code: error.code,
                    details: error.details
                });
                console.error('Full error:', error);
            }
        }
        
        // Run test when page loads
        window.addEventListener('load', testRecommendationsAPI);
    </script>
</body>
</html>